# Сравнение содержимого почтовых ящиков при миграции из Exchange в Яндекс 360

Комплексное решение для верификации полноты миграции электронной почты из Microsoft Exchange в Яндекс 360. Позволяет выгрузить перечень сообщений из обеих почтовых систем и автоматически сопоставить их, выявляя письма, которые не были перенесены, были потеряны или задублированы в процессе миграции.

## Состав решения

Решение состоит из двух независимых компонентов, каждый из которых выгружает заголовки сообщений из соответствующей почтовой системы в единый CSV-формат, и встроенного механизма сравнения.

### 1. Выгрузка сообщений из Exchange

**Каталог:** [`get_exchange_messages/`](get_exchange_messages/)

Консольное приложение на C# для массовой выгрузки заголовков сообщений из Microsoft Exchange через EWS (Exchange Web Services). Поддерживает подключение через Autodiscover или прямой EWS URL, параллельную обработку нескольких ящиков и работу от имени администратора (Full Access или Application Impersonation).

**Ключевые характеристики:**
- Платформа: Windows
- Требования: Exchange 2013+
- Аутентификация: учётная запись с Full Access или ролью ApplicationImpersonation
- Вход: список SMTP-адресов (`input_mailboxes.txt`)
- Выход: CSV-файлы с заголовками сообщений для каждого ящика

Подробная документация: [get_exchange_messages/README.md](get_exchange_messages/README.md)

### 2. Выгрузка сообщений из Яндекс 360 и сравнение

**Каталог:** [`get_y360_imap_messages/`](get_y360_imap_messages/)

Python-скрипт для выгрузки заголовков сообщений из IMAP-ящиков Яндекс 360 и последующего сравнения содержимого ящиков между двумя почтовыми системами. Поддерживает несколько режимов аутентификации (делегирование, сервисное приложение, гибридный), многопоточную обработку и гибкую фильтрацию при сравнении.

**Ключевые характеристики:**
- Платформа: Linux, macOS, Windows (Python 3.9+)
- Аутентификация: OAuth-токен Яндекс 360, делегированный доступ или сервисное приложение
- Вход: список почтовых ящиков (`mailboxes.csv`)
- Выход: CSV-файлы с заголовками сообщений, отчёты о сравнении и файлы расхождений

Подробная документация: [get_y360_imap_messages/README.md](get_y360_imap_messages/README.md)

## Единый формат данных

Оба компонента формируют CSV-файлы с одинаковой структурой (разделитель `;`):

```
nn;folder;date;from;subject;message-id;size
```

| Поле | Описание |
|------|----------|
| `nn` | Порядковый номер сообщения |
| `folder` | Папка в почтовом ящике |
| `date` | Дата и время из заголовка `Date` |
| `from` | Отправитель из заголовка `From` |
| `subject` | Тема из заголовка `Subject` |
| `message-id` | Уникальный идентификатор из заголовка `Message-ID` |
| `size` | Размер сообщения в байтах |

Сопоставление сообщений при сравнении выполняется по полю `message-id`.

## Общая схема работы

```
┌─────────────────────┐         ┌─────────────────────┐
│   Microsoft Exchange│         │     Яндекс 360      │
│                     │         │                      │
│  ┌───────────────┐  │         │  ┌───────────────┐   │
│  │ Почтовый ящик │  │         │  │ Почтовый ящик │   │
│  └───────┬───────┘  │         │  └───────┬───────┘   │
└──────────┼──────────┘         └──────────┼───────────┘
           │                               │
     EWS API                         IMAP протокол
           │                               │
           ▼                               ▼
┌──────────────────┐            ┌───────────────────┐
│ get_exchange_    │            │ get_y360_imap_    │
│ messages         │            │ messages          │
│ (C# / Windows)  │            │ (Python)          │
└────────┬─────────┘            └─────────┬─────────┘
         │                                │
         ▼                                ▼
┌──────────────────┐            ┌───────────────────┐
│ CSV-файлы        │            │ CSV-файлы         │
│ (источник)       │            │ (назначение)      │
└────────┬─────────┘            └─────────┬─────────┘
         │                                │
         │    ┌────────────────────┐      │
         └───►│   Сравнение        │◄─────┘
              │ (imap_helper.py,   │
              │  пункт меню 2)     │
              └────────┬───────────┘
                       │
                       ▼
              ┌────────────────────┐
              │ Отчёт о расхож-   │
              │ дениях + файлы     │
              │ отсутствующих      │
              │ сообщений          │
              └────────────────────┘
```

## Порядок использования

### 1. Выгрузка из Exchange

1. Разместите `ExchangeMessagesDownloader.exe`, `config.cfg` и `input_mailboxes.txt` на Windows-машине с сетевым доступом к Exchange.
2. Укажите в `config.cfg` параметры подключения (EWS URL или Autodiscover, учётные данные).
3. Перечислите ящики для экспорта в `input_mailboxes.txt`.
4. Запустите `ExchangeMessagesDownloader.exe`.
5. CSV-файлы с заголовками сообщений будут сохранены в каталог `output_dir`.

### 2. Выгрузка из Яндекс 360

1. Установите зависимости: `pip install -r requirements.txt`.
2. Настройте файл `.env` с OAuth-токеном, ID организации и параметрами подключения.
3. Заполните `mailboxes.csv` списком ящиков.
4. Запустите `python imap_helper.py` и выберите пункт `1` (выгрузка сообщений).
5. CSV-файлы будут сохранены в каталог `imap_messages/`.

### 3. Сравнение

1. Создайте структуру каталогов для сравнения:
   ```bash
   mkdir -p compare/mig_01/a compare/mig_01/b
   ```
2. Скопируйте CSV-файлы из Exchange в папку `a/`, из Яндекс 360 — в папку `b/`.
3. При необходимости настройте фильтрацию в `filter_rules.txt`.
4. Запустите `python imap_helper.py` и выберите пункт `2` (сравнение).
5. Укажите цикл сравнения и диапазон дат.
6. Результаты появятся в папке `result/`: сводный отчёт и файлы расхождений для каждого ящика.

### 4. Анализ результатов

- **`_result_<timestamp>.csv`** — сводная таблица: количество сообщений в источнике, назначении и число не найденных для каждого ящика.
- **`<alias>_diff_<timestamp>.csv`** — список конкретных сообщений, отсутствующих в целевой системе.
- `missed_count = 0` означает, что все сообщения из источника присутствуют в назначении.
- `missed_count > 0` указывает на незавершённую миграцию; детали — в файле расхождений.

## Структура репозитория

```
imap_messages_count/
├── get_exchange_messages/          # Выгрузка из Exchange (C#)
│   ├── Publish/                    # Готовое приложение и конфигурация
│   │   ├── config.cfg
│   │   └── input_mailboxes.txt
│   ├── source/                     # Исходный код
│   │   ├── program.cs
│   │   ├── ExchangeMessagesDownloader.csproj
│   │   └── ExchangeMessagesDownloader.slnx
│   └── README.md
├── get_y360_imap_messages/         # Выгрузка из Яндекс 360 и сравнение (Python)
│   ├── Imap_helper.py
│   ├── requirements.txt
│   ├── mailboxes.csv
│   ├── filter_rules.txt
│   ├── .env
│   └── README.md
└── README.md                       # Этот файл
```
